<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Details</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Post Details</h1>
    </header>
    <div class="posts-grid">
        <div class="postCard" id="postDetails">
            <h1 class="postTitle" id="detailsTitle">Loading...</h1>
            <p class="postBody" id="detailsBody"></p>
            <div id="postMeta" style="margin-bottom:12px;"></div>
            <div class="post-inputs">
                <input type="text" id="editTitle" class="titleTextBox" placeholder="Edit Post Title">
                <textarea id="editBody" class="bodyTextBox" placeholder="Edit Post Body"></textarea>
            </div>
            <div class="post-actions">
                <input type="button" value="Update" class="btn btn-secondary" id="updateBtn">
                <input type="button" value="Delete" class="btn btn-danger" id="deleteBtn">
                <input type="button" value="Back" class="btn btn-secondary" id="backBtn">
            </div>
        </div>
    </div>
    <div class="commentsSection" id="commentsSection">
        <h2>Comments</h2>
        <div class="commentsContainer" id="commentsContainer"></div>
        <div class="comment-inputs">
            <input type="text" id="commentTitle" class="commentTitleTextBox" placeholder="Enter Comment Title">
            <input type="email" id="commentEmail" class="commentEmailTextBox" placeholder="Enter E-mail">
            <textarea id="commentBody" class="commentBodyTextBox" placeholder="Enter Comment Body"></textarea>
            <input type="button" value="Add Comment" class="btn btn-primary" id="addCommentBtn">
        </div>
    </div>
    <dialog id="validationDialog" class="validation-dialog">
        <p id="dialogMessage"></p>
        <button id="dialogCloseBtn" autofocus>Close</button>
    </dialog>
    <script>
        // --- Utility functions for validation and dialog ---
        const dialog = document.getElementById('validationDialog');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogCloseBtn = document.getElementById('dialogCloseBtn');
        function showMessage(message, type = 'error') {
            dialogMessage.textContent = message;
            dialogMessage.style.color = (type === 'error') ? 'var(--danger-color)' : '#4CAF50';
            dialog.showModal();
            if (type === 'success') {
                setTimeout(() => dialog.close(), 3000);
            }
        }
        dialogCloseBtn.addEventListener('click', () => dialog.close());
        dialog.addEventListener('click', (e) => { if (e.target === dialog) dialog.close(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && dialog.open) dialog.close(); });
        function clearValidationErrors() {
            document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));
        }
        function validateRequired(value, fieldName) {
            if (!value.trim()) return `${fieldName} is required`;
            return null;
        }
        function validateLength(value, fieldName, min, max) {
            if (min && value.length < min) return `${fieldName} must be at least ${min} characters long`;
            if (max && value.length > max) return `${fieldName} must be no more than ${max} characters long`;
            return null;
        }
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        // --- End utility ---

        // Get post ID from URL
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('id');
        const postDetails = document.getElementById('postDetails');
        const detailsTitle = document.getElementById('detailsTitle');
        const detailsBody = document.getElementById('detailsBody');
        const postMeta = document.getElementById('postMeta');
        const editTitle = document.getElementById('editTitle');
        const editBody = document.getElementById('editBody');
        const updateBtn = document.getElementById('updateBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const backBtn = document.getElementById('backBtn');
        const commentsContainer = document.getElementById('commentsContainer');
        const commentTitle = document.getElementById('commentTitle');
        const commentEmail = document.getElementById('commentEmail');
        const commentBody = document.getElementById('commentBody');
        const addCommentBtn = document.getElementById('addCommentBtn');
        let currentPost = null;

        if (!postId) {
            detailsTitle.textContent = 'No post ID provided.';
            updateBtn.disabled = true;
            deleteBtn.disabled = true;
            addCommentBtn.disabled = true;
        } else {
            // Fetch post data
            fetch(`https://jsonplaceholder.typicode.com/posts/${postId}`)
                .then(res => res.json())
                .then(post => {
                    currentPost = post;
                    detailsTitle.textContent = post.title;
                    detailsBody.textContent = post.body;
                    postMeta.innerHTML = `<strong>Post ID:</strong> ${post.id} &nbsp; <strong>User ID:</strong> ${post.userId}`;
                    editTitle.value = post.title;
                    editBody.value = post.body;
                })
                .catch(() => {
                    detailsTitle.textContent = 'Failed to load post.';
                    updateBtn.disabled = true;
                    deleteBtn.disabled = true;
                    addCommentBtn.disabled = true;
                });
            // Fetch comments
            fetch(`https://jsonplaceholder.typicode.com/posts/${postId}/comments`)
                .then(res => res.json())
                .then(comments => {
                    commentsContainer.innerHTML = '';
                    if (comments.length === 0) {
                        commentsContainer.innerHTML = '<div style="text-align:center;color:var(--text-light);padding:20px;font-style:italic;">No comments yet. Be the first to comment!</div>';
                    } else {
                        comments.forEach(comment => {
                            const card = document.createElement('div');
                            card.className = 'commentCard';
                            card.innerHTML = `<h3>${comment.name}</h3><p class="commentEmail">Email: ${comment.email}</p><p class="commentBody">${comment.body}</p>`;
                            commentsContainer.appendChild(card);
                        });
                    }
                });
        }
        // Update post
        updateBtn.onclick = function () {
            clearValidationErrors();
            let valid = true;
            const titleError = validateRequired(editTitle.value, 'Title') || validateLength(editTitle.value, 'Title', 3, 100);
            const bodyError = validateRequired(editBody.value, 'Body') || validateLength(editBody.value, 'Body', 10, 1000);
            if (titleError) {
                editTitle.classList.add('validation-error');
                showMessage(titleError);
                valid = false;
            }
            if (bodyError) {
                editBody.classList.add('validation-error');
                showMessage(bodyError);
                valid = false;
            }
            if (!valid) return;
            updateBtn.value = 'Updating...';
            updateBtn.disabled = true;
            fetch(`https://jsonplaceholder.typicode.com/posts/${postId}`, {
                method: 'PATCH',
                body: JSON.stringify({
                    title: editTitle.value.trim(),
                    body: editBody.value.trim()
                }),
                headers: { 'Content-type': 'application/json' },
            })
                .then(res => res.json())
                .then(data => {
                    detailsTitle.textContent = data.title;
                    detailsBody.textContent = data.body;
                    showMessage('Post updated successfully!', 'success');
                })
                .catch(() => showMessage('Failed to update post.'))
                .finally(() => {
                    updateBtn.value = 'Update';
                    updateBtn.disabled = false;
                });
        };
        // Delete post
        deleteBtn.onclick = function () {
            if (!confirm('Are you sure you want to delete this post?')) return;
            deleteBtn.value = 'Deleting...';
            deleteBtn.disabled = true;
            fetch(`https://jsonplaceholder.typicode.com/posts/${postId}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        showMessage('Post deleted successfully!', 'success');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1200);
                    } else {
                        showMessage("Something went wrong on deleting the post. Please check you internet connection!")
                    }
                })
                .catch(() => showMessage('Failed to delete post.'))
                .finally(() => {
                    deleteBtn.value = 'Delete';
                    deleteBtn.disabled = false;
                });
        };
        // Back button
        backBtn.onclick = function () {
            window.location.href = 'index.html';
        };
        // Add comment
        addCommentBtn.onclick = function () {
            clearValidationErrors();
            let valid = true;
            const titleError = validateRequired(commentTitle.value, 'Comment title') || validateLength(commentTitle.value, 'Comment title', 2, 50);
            const emailError = validateRequired(commentEmail.value, 'Email') || (!validateEmail(commentEmail.value) ? 'Please enter a valid email address' : null);
            const bodyError = validateRequired(commentBody.value, 'Comment body') || validateLength(commentBody.value, 'Comment body', 5, 500);
            if (titleError) {
                commentTitle.classList.add('validation-error');
                showMessage(titleError);
                valid = false;
            }
            if (emailError) {
                commentEmail.classList.add('validation-error');
                showMessage(emailError);
                valid = false;
            }
            if (bodyError) {
                commentBody.classList.add('validation-error');
                showMessage(bodyError);
                valid = false;
            }
            if (!valid) return;
            addCommentBtn.value = 'Adding...';
            addCommentBtn.disabled = true;
            fetch(`https://jsonplaceholder.typicode.com/posts/${postId}/comments`, {
                method: 'POST',
                body: JSON.stringify({
                    name: commentTitle.value.trim(),
                    email: commentEmail.value.trim(),
                    body: commentBody.value.trim(),
                    postId: postId
                }),
                headers: { 'Content-type': 'application/json' },
            })
                .then(res => res.json())
                .then(comment => {
                    const card = document.createElement('div');
                    card.className = 'commentCard';
                    card.innerHTML = `<h3>${comment.name}</h3><p class="commentEmail">Email: ${comment.email}</p><p class="commentBody">${comment.body}</p>`;
                    commentsContainer.appendChild(card);
                    showMessage('Comment added successfully!', 'success');
                    commentTitle.value = '';
                    commentEmail.value = '';
                    commentBody.value = '';
                })
                .catch(() => showMessage('Failed to add comment.'))
                .finally(() => {
                    addCommentBtn.value = 'Add Comment';
                    addCommentBtn.disabled = false;
                });
        };
    </script>
</body>

</html>